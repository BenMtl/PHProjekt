//>>built
require({cache:{"url:phpr/template/bookingList.html":'<div>\n    <div class="selectedDate"><span data-dojo-attach-point="selectedDate"></span></div>\n    <div data-dojo-attach-point="bookingCreator" data-dojo-type="phpr/BookingList/BookingCreator"></div>\n    <div data-dojo-attach-point="content, containerNode"></div>\n    <div data-dojo-attach-point="summaryRow" class="summaryRow"\n        >Total: <span data-dojo-attach-point="hoursWorked"></span\n        ><span data-dojo-attach-point="hoursToWorkText" style="display: none;"> of <span data-dojo-attach-point="hoursToWork"></span\n        > this month.</div>\n</div>\n'}});
define("phpr/BookingList","dojo/_base/array,dojo/_base/declare,dijit/_WidgetBase,dijit/_TemplatedMixin,dijit/_WidgetsInTemplateMixin,dojo/date/locale,dojo/html,dojo/json,dojo/when,dojo/store/JsonRest,dojo/store/Memory,dojo/store/Observable,dojo/store/Cache,dojo/date,dojo/dom-construct,dojo/dom-class,dojo/dom-style,phpr/BookingList/DayBlock,phpr/Timehelper,phpr/JsonRestQueryEngine,dojo/_base/lang,phpr/Api,phpr/Timehelper,dojo/text!phpr/template/bookingList.html,phpr/BookingList/BookingCreator,dijit/form/FilteringSelect,dijit/form/ValidationTextBox,dijit/form/Textarea,dijit/form/Button,dijit/form/DateTextBox,dijit/form/Form,phpr/DateTextBox".split(","),
function(e,k,l,m,n,o,p,q,i,r,s,t,u,h,v,C,w,x,d,y,g,z,j,A){return k([l,m,n],{store:null,date:new Date,templateString:A,observer:null,data:null,day2dayBlock:null,constructor:function(){this._setStoreAttr(new r({target:"index.php/Timecard/Timecard/",queryEngine:y}));this.data=[];this.day2dayBlock={}},startup:function(){this.inherited(arguments);this._update()},_setStoreAttr:function(a){this.store=new t(new u(a,new s));this._update()},_setDateAttr:function(a){var b=!this._started||a.getFullYear()!==this.date.getFullYear()||
a.getMonth()!==this.date.getMonth();this.date=a;p.set(this.selectedDate,o.format(a,{selector:"date",datePattern:"MMMM yyy"}));this.bookingCreator.set("date",a);b&&this._update()},_updating:!1,_update:function(){if(!this._updating&&this._started){this._updating=!0;this.bookingCreator.set("store",this.store);if(this.observer)this.observer.cancel(),this.observer=null;var a=this.store.query({filter:this._getQueryString()},{sort:[{attribute:"start_datetime",descending:!0}]});i(a,g.hitch(this,function(a){var c=
this._partitionBookingsByDay(a);this.data=g.clone(a);v.empty(this.content);this.day2dayBlock={};this._addBookingsPartitionedByDay(c);this._updateHoursWorked();this._updating=!1}));this.observer=a.observe(g.hitch(this,"_storeChanged"),!0)}},_updateHoursWorked:function(){var a=0;e.forEach(this.data,function(b){var c=j.datetimeToJsDate(b.startDatetime),b=j.timeToJsDate(b.endTime);b.setFullYear(c.getFullYear());b.setMonth(c.getMonth());b.setDate(c.getDate());a+=h.difference(c,b,"minute")});this.hoursWorked.innerHTML=
""+Math.floor(a/60)+"h";0!==a&&(this.hoursWorked.innerHTML+=" "+a%60+"m")},_updateHoursToWork:function(){z.getData("index.php/Timecard/Index/minutesToWork",{query:{month:this.date.getMonth()+1,year:this.date.getFullYear()}}).then(g.hitch(this,function(a){if(0!==a.minutesToWork){var b=a.minutesToWork%60;this.hoursToWork.innerHTML=""+Math.floor(a.minutesToWork/60)+"h";0!==b&&(this.hoursToWork.innerHTML+=" "+b+"m");w.set(this.hoursToWorkText,"display","")}}))},_storeChanged:function(a,b,c){var a=g.clone(a),
f=d.datetimeToJsDate(a.startDatetime);if(-1<b){var B=d.datetimeToJsDate(this.data[b].startDatetime);this.data.splice(b,1);this._reloadDay(B)}-1<c&&this.data.splice(c,0,a);this._updateHoursWorked();this._reloadDay(f,f)},_reloadDay:function(a,b){var c=new Date(a.getFullYear(),a.getMonth(),a.getDate()),f=this.store.query({filter:this._getQueryString(c,h.add(c,"day",1))});i(f,g.hitch(this,function(a){var f=this.day2dayBlock[c.getTime()];f&&f.widget&&(f.widget.destroyRecursive(),delete this.day2dayBlock[c.getTime()]);
a=this._partitionBookingsByDay(a);b&&e.some(a,function(a){return e.some(a.bookings,function(a){var c=0===h.compare(d.datetimeToJsDate(a.startDatetime),b);if(c)a.highlight=!0;return c})});this._addBookingsPartitionedByDay(a)}))},_addBookingsPartitionedByDay:function(a){e.forEach(a,this._addDayBlock,this);this._reorderDayWidgets()},_addDayBlock:function(a){var b=this.day2dayBlock[a.day.getTime()];b&&b.widget&&(b.widget.destroyRecursive(),delete this.day2dayBlock[a.day.getTime()]);a.store=this.store;
widget=new x(a);widget.placeAt(this.content);this.own(widget);this.day2dayBlock[a.day.getTime()]={widget:widget,placed:!1}},_getQueryString:function(a,b){a||(a=this.date||new Date,a=new Date(a.getFullYear(),a.getMonth(),1));b=b||h.add(a,"month",1);return q.stringify({startDatetime:{"!ge":d.jsDateToIsoDatetime(a),"!lt":d.jsDateToIsoDatetime(b)}})},_partitionBookingsByDay:function(a){var b={};e.forEach(a,function(a){var c=d.datetimeToJsDate(a.startDatetime),c=new Date(c.getFullYear(),c.getMonth(),c.getDate());
b[c]=b[c]||[];b[c].push(a)});var a=[],c;for(c in b)a.push({day:new Date(c),bookings:b[c]});return a},_reorderDayWidgets:function(){var a=[],b;for(b in this.day2dayBlock)a.push({ts:b,entry:this.day2dayBlock[b]});a.sort(function(a,b){return parseInt(b.ts,10)>parseInt(a.ts,10)});e.forEach(a,function(a,b,e){if(!1===a.entry.placed){var d=a.entry.widget;0===b?d.placeAt(this.content,"first"):b===e.length-1?d.placeAt(this.content,"last"):d.placeAt(e[b-1].entry.widget,"after");a.entry.placed=!0}},this)}})});