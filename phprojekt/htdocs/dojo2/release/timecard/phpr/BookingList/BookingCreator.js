//>>built
require({cache:{"url:phpr/template/bookingList/bookingCreator.html":'<div class="bookingCreator">\n    <div class="bookingForm" data-dojo-attach-point="form" data-dojo-type="dijit/form/Form">\n        <select data-dojo-attach-point="project"\n                name="project"\n                data-dojo-type="phpr/ProjectChooser">\n        </select>\n        <input type="text"\n               name="start"\n               required="true"\n               data-dojo-type="phpr/TimeBox"\n               data-dojo-attach-point="start"\n               data-dojo-props="placeholder: \'Start\'"\n               class="time"/>\n        -\n        <input type="text"\n               name="end"\n               data-dojo-type="phpr/TimeBox"\n               data-dojo-attach-point="end"\n               data-dojo-props="allowEmpty: true, placeholder: \'End\'"\n               class="time"/>\n        <input type="text"\n               name="date"\n               data-dojo-type="phpr/DateTextBox"\n               value="today"\n               data-dojo-attach-point="date"\n               class="date"/>\n        <textarea name="notes"\n                  class="notes"\n                  data-dojo-type="dijit/form/Textarea"\n                  data-dojo-props="placeholder: \'Notes\'"\n                  data-dojo-attach-point="notes"></textarea>\n        <button data-dojo-type="dijit/form/Button"\n                type="submit"\n                data-dojo-props="baseClass: \'submitButton\'">Book it!</button>\n    </div>\n</div>\n'}});
define("phpr/BookingList/BookingCreator","dojo/_base/declare,dojo/_base/lang,dojo/_base/array,dojo/on,dojo/number,dojo/promise/all,dojo/topic,dojo/json,dojo/store/JsonRest,dojo/store/Memory,dijit/Tooltip,phpr/BookingList/BookingBlock,phpr/Api,phpr/Timehelper,dojo/text!phpr/template/bookingList/bookingCreator.html,phpr/TimeBox".split(","),function(i,f,q,j,g,r,h,k,l,s,m,n,o,d,p){return i([n],{templateString:p,store:null,projectDeferred:null,buildRendering:function(){this.inherited(arguments);this.date.set("value",
new Date);this.own(this.form.on("submit",f.hitch(this,this._submit)))},_setBookingAttr:function(a){var c=function(a){return g.format(a.getHours(),{pattern:"00"})+":"+g.format(a.getMinutes(),{pattern:"00"})};this.project.set("value",""+a.projectId);var e=d.datetimeToJsDate(a.startDatetime);this.start.set("value",c(e));this.date.set("value",e);a.endTime&&(e=d.timeToJsDate(a.endTime),this.end.set("value",c(e)));a.notes&&this.notes.set("value",a.notes);this.booking=a},postCreate:function(){if(!this.store)this.store=
new l({target:"index.php/Timecard/Timecard/"});this.own(j(this.notes,"keydown",f.hitch(this,function(a){"Enter"===a.keyIdentifier&&(a.shiftKey?this.notes.set("value",this.notes.get("value")+"\n"):this.form.submit(),a.preventDefault())})));this.end.validate=this._endValidateFunction(this.end.validate,this.start)},_showErrorInWarningIcon:o.errorHandlerForTag("bookingCreator"),_submit:function(a){a&&a.stopPropagation();if(this.form.validate()){var a=this.form.get("value"),c=this._prepareDataForSend(a);
this.emit("create",a);c&&this.store.put(c).then(function(){h.publish("notification/clear","bookingCreator");h.publish("timecard/bookingCreated",c)},f.hitch(this,function(a){try{var b=k.parse(a.responseText,!0);b.error&&"overlappingEntry"===b.error?this._markOverlapError():this._showErrorInWarningIcon(a)}catch(c){this._showErrorInWarningIcon(a)}}))}return!1},_markOverlapError:function(){this.start.set("state","Error");this.end.focus();this.end.set("state","Error");this.end.set("message","The entry overlaps with an existing one")},
_prepareDataForSend:function(a){var c={},e=d.parseTime(a.start),b=d.parseTime(a.end);if(!e)return!1;b&&(b=d.jsDateToIsoTime(b)+":00");c.endTime=b;if(a.id)c.id=a.id;b=new Date(a.date.getTime());b.setHours(e.getHours());b.setMinutes(e.getMinutes());c.startDatetime=d.jsDateToIsoDatetime(b)+":00";c.notes=a.notes||"";c.projectId=a.project||"1";return c},_setDateAttr:function(a){this.date.set("value",a)},_endValidateFunction:function(a,c){return function(e){var b=a.apply(this,arguments);if(!b)return b;
var d=this.get("value"),f=!1;if(d.match(/^\d{3}$/)){if(e)return b;f=!0}b=parseInt(c.get("value").replace(/D/g,""));d=parseInt(d.replace(/\D/g,""),10);return b>=d?(this._maskValidSubsetError=!1,this.focusNode.setAttribute("aria-invalid","true"),this.set("state","Error"),this.set("message","End time must be after start time"),f&&m.show("End time must be after start time",this.domNode,this.tooltipPosition,!this.isLeftToRight()),!1):!0}}})});